<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">    
	</head>
<body>

</body>
</html>

<script>

class ObservableMap extends EventTarget
{
	constructor()
	{
		super();
		this._map = new Map();
	}

	set( id, value )
	{
		if( this._map.has(id))
		{
			this._map.set(id,value);
			this.dispatchEvent( new CustomEvent('update', {detail:{id:id}}));
		}
		else
		{
			this._map.set(id,value);
			this.dispatchEvent( new CustomEvent('insert', {detail:{id:id}}));
		}
	}

	get( id )
	{
		return this._map.get(id);
	}

	delete(id)
	{
		if ( this._map.delete(id))
			this.dispatchEvent( new CustomEvent('delete', {detail:{id:id}}));

		if( this._map.size == 0)
			this.dispatchEvent( new CustomEvent('empty'));
	}

	clear()
	{
		this._map.clear();
		this.dispatchEvent( new CustomEvent('empty'));
	}

	get size()
	{
		return this._map.size;
	}

	values()
	{
		return this._map.values();
	}

	entries()
	{
		return this._map.entries();
	}

	keys()
	{
		return this._map.keys();
	}

};


class HTMLDataTableView extends HTMLElement
{
	constructor()
	{
		super();

		this.attachShadow({ mode: 'open' });

		//ui elements
		this._table = document.createElement('table');
		this._table.createTBody();
		this._table.createTHead();
		this._table.createTFoot();
		this._table.tHead.insertRow();		
	}

	insertColumn()
	{
		let tr = this._table.tHead.rows[0];
		let th = document.createElement('th');
		tr.appendChild(th);
		return th;
	}

	deleteColumn(index)
	{
		this._table.tHead.rows[0].deleteCell( index );
	}

	insertRow(index)
	{
		return this._table.tBodies[0].insertRow(index);
	}

	deleteRow(index)
	{
		this._table.tBodies[0].deleteRow( index );
	}

	get columns()
	{
		return this._table.tHead.rows[0].cells;
	}

	get rows()
	{
		return this._table.tBodies[0].rows;
	}

	connectedCallback()
	{
		this.shadowRoot.appendChild( document.createElement('style') );
		this.shadowRoot.styleSheets[0].insertRule("@import 'test.css'");
		this.shadowRoot.appendChild(this._table);
	}

}

customElements.define('x-datatableview', HTMLDataTableView );

class HTMLDataTableElement extends HTMLElement
{
	constructor()
	{
		super();

		this._rows = new ObservableMap();
		this._columns = new ObservableMap();
		this.table = new HTMLDataTableView();

		//model event handlers connections
		this.rows.addEventListener('insert', event => this.onrowinsert(event));
		this.rows.addEventListener('delete', event => this.onrowdelete(event));
		this.rows.addEventListener('update', event => this.onrowupdate(event));
		this.columns.addEventListener('insert', event => this.oncolumninsert(event));
		this.columns.addEventListener('delete', event => this.oncolumnupdate(event));
		this.columns.addEventListener('update', event => this.oncolumnupdate(event));
	}

	//model event handler implementation

	onrowinsert(event)
	{
		let data = this.rows.get(event.detail.id);		
		let row = this.table.insertRow();

		for( let [id,col] of this.columns.entries() )
		{
			let cell = row.insertCell();
			cell.innerText = data[col.map];
		}

		row.bind = event.detail.id;
	}

	onrowupdate(event)
	{
		let data = this.rows.get(event.detail.id);
		let tr = this.getRowBy(event.detail.id);
		
		for( let [id,col] of this.columns.entries() )
		{
			let cell = row.insertCell();
			cell.innerText = data[col.map];
		}
	}

	onrowdelete(event)
	{
		this.table.deleteRow( this.getRowBy(event.detail.id).rowIndex );
	}

	oncolumninsert(event)
	{
		let data = this.columns.get(event.detail.id);
		let th = this.table.insertColumn();
		th.innerText = data.title;
	}

	oncolumnupdate(event)
	{
		let th = this.getColumnBy(event.detail.id);
		let data = this.columns.get(event.detail.id);

		th.innerText = data;
	}

	oncolumndelete(event)
	{
		this.table.deleteColumn( this.getColumnBy(event.detail.id).cellIndex );
	}

	//view handler implementation

	connectedCallback() 
	{
		this.appendChild( this.table );

		//view handler connections
    }

	adoptedCallback()
    {

    }

    disconnectedCallback()
    {
    	//view handler disconnections
    }

    attributeChangedCallback(attrName, oldVal, newVal)
    {

    }

    static get observedAttributes() 
    {
    	return [];
	}

	//web-component-api (view/model integration)
	get columns()
	{
		return this._columns;
	}

	get rows()
	{
		return this._rows;
	}

	getRowBy( bindingId )
	{
		for( let r of this._table.rows )
		{
			if( r.bind === bindingId )
				return r;
		}
	}

	getColumnBy( bindingId )
	{
		for( let r of this._table._columns )
		{
			if( r.bind === bindingId )
				return r;
		}
	}
}

customElements.define('x-datatable', HTMLDataTableElement );

let dt = new HTMLDataTableElement();

dt.columns.set(0, { title:'A', map: 0 });
dt.columns.set(1, { title:'B', map: 1 });
dt.columns.set(2, { title:'C', map: 2 });
dt.columns.set(3, { title:'D', map: 3 });
dt.columns.set(4, { title:'E', map: 4 });

dt.rows.set(1,[0,9,9,9,9]);
dt.rows.set(2,[0,9,9,9,9]);
dt.rows.set(3,[0,9,9,9,9]);
dt.rows.set(4,[0,9,9,9,9]);
dt.rows.set(5,[0,9,9,9,9]);

document.body.appendChild(dt);

</script>